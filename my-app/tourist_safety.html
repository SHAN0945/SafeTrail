<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Tourist Safety System</title>
    <style>
        html, body {
            height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif;
        }
        #map {
            height: 100%; width: 100%;
        }
        #sosButton {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 5;
            background-color: #d9534f; color: white; padding: 15px 25px; border: none;
            border-radius: 50px; font-size: 1.2em; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); transition: background-color 0.3s;
        }
        #sosButton:hover { background-color: #c9302c; }
        #topRightButtons {
            position: fixed; top: 15px; right: 15px; z-index: 5;
            display: flex; flex-direction: column; gap: 10px;
        }
        #resetButton, #clearPinsButton {
            background-color: #5bc0de; color: white; padding: 10px 15px; border: none;
            border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #clearPinsButton { background-color: #f0ad4e; }
        #status {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 5;
            background-color: rgba(0, 0, 0, 0.7); color: white; padding: 10px 20px;
            border-radius: 20px; display: none; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        .info-window-content {
             padding: 5px; color: #333; max-width: 250px;
        }
        .info-window-content h4 {
            margin: 0 0 10px 0; border-bottom: 1px solid #ccc; padding-bottom: 5px;
        }
        .info-window-content p { margin: 5px 0; font-size: 0.9em; }
        .info-window-content b { color: #000; }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 10;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: white; padding: 25px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 400px;
        }
        .modal-content h3 { margin-top: 0; }
        .modal-content .form-group { margin-bottom: 15px; }
        .modal-content label { display: block; margin-bottom: 5px; font-weight: bold; }
        .modal-content select, .modal-content input {
            width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box;
        }
        .modal-buttons {
            display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;
        }
        .modal-buttons button {
            padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;
        }
        #sos-submit-btn { background-color: #d9534f; color: white; }
        #sos-cancel-btn { background-color: #ccc; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="status">Getting your location...</div>
    <button id="sosButton">ðŸš¨ SOS (My Location)</button>
    
    <div id="topRightButtons">
        <button id="resetButton">Reset Safety Circle</button>
        <button id="clearPinsButton">Clear SOS Pins</button>
    </div>

    <div id="sos-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>SOS Alert Details</h3>
            <p>Please provide more information for the alert.</p>
            <form id="sos-form">
                <div class="form-group">
                    <label for="risk-level">Risk Level</label>
                    <select id="risk-level" name="risk-level" required>
                        <option value="Low">Low</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="distress-type">Type of Distress</label>
                    <select id="distress-type" name="distress-type" required>
                        <option value="Medical">Medical</option>
                        <option value="Theft">Theft</option>
                        <option value="Harassment">Harassment</option>
                        <option value="Lost">Lost</option>
                        <option value="Other">Other (Specify)</option>
                    </select>
                </div>
                <div class="form-group hidden" id="other-distress-group">
                    <label for="other-distress">Please Specify</label>
                    <input type="text" id="other-distress" name="other-distress">
                </div>
                <input type="hidden" id="sos-lat" name="sos-lat">
                <input type="hidden" id="sos-lng" name="sos-lng">
                <input type="hidden" id="sos-type" name="sos-type">
                <div class="modal-buttons">
                    <button type="button" id="sos-cancel-btn">Cancel</button>
                    <button type="submit" id="sos-submit-btn">Submit SOS</button>
                </div>
            </form>
        </div>
    </div>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAT-2YizCdIxUBSRIG0LKsUzXVddCzMOec&libraries=geometry&callback=initMap">
    </script>

    <script>
        // --- Global Variables ---
        let map, userMarker, pinnedMarker, infoWindow, dangerZoneCircle;
        let hasEnteredDangerZone = false;
        let dangerZoneCenter = null, dangerZoneRadius = null;
        let sosHistoryMarkers = [];

        function initMap() {
            const initialCenter = { lat: 12.9716, lng: 77.5946 };
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15, center: initialCenter, mapTypeId: 'roadmap'
            });
            
            // Event Listeners
            document.getElementById('sosButton').addEventListener('click', triggerMyLoctionSOS);
            document.getElementById('resetButton').addEventListener('click', resetGeofence);
            document.getElementById('clearPinsButton').addEventListener('click', clearSosPins);
            map.addListener('click', (event) => placePinAndShowWindow(event.latLng));
            
            // Modal Listeners
            document.getElementById('sos-form').addEventListener('submit', handleSosFormSubmit);
            document.getElementById('sos-cancel-btn').addEventListener('click', hideSosModal);
            document.getElementById('distress-type').addEventListener('change', (e) => {
                document.getElementById('other-distress-group').classList.toggle('hidden', e.target.value !== 'Other');
            });

            loadGeofenceFromStorage();
            loadSosHistoryFromStorage();
            startLocationTracking();
        }

        // --- SOS Modal and Form Functions ---

        function showSosModal(position, type) {
            document.getElementById('sos-lat').value = position.lat;
            document.getElementById('sos-lng').value = position.lng;
            document.getElementById('sos-type').value = type;
            document.getElementById('sos-modal').classList.remove('hidden');
        }

        function hideSosModal() {
            document.getElementById('sos-modal').classList.add('hidden');
            document.getElementById('sos-form').reset();
            document.getElementById('other-distress-group').classList.add('hidden');
        }

        function handleSosFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const lat = parseFloat(form['sos-lat'].value);
            const lng = parseFloat(form['sos-lng'].value);
            const type = form['sos-type'].value;
            
            let distressValue = form['distress-type'].value;
            if (distressValue === 'Other') {
                distressValue = form['other-distress'].value || 'Other';
            }

            const details = {
                risk: form['risk-level'].value,
                distress: distressValue
            };

            hideSosModal();
            // **MODIFIED ALERT**
            alert(`ðŸš¨ SOS SENT! ðŸš¨\n\nResponders notified with your alert details for location:\n\nLatitude: ${lat.toFixed(5)}\nLongitude: ${lng.toFixed(5)}`);
            addSosPinToMap({ lat, lng }, type, details);
        }

        // --- SOS History & Pin Functions ---

        function loadSosHistoryFromStorage() {
            const savedPins = localStorage.getItem('sosHistory');
            if (savedPins) {
                JSON.parse(savedPins).forEach(pin => addSosPinToMap(pin.position, pin.type, pin.details, false));
            }
        }

        function addSosPinToMap(position, type, details, shouldSave = true) {
            const iconColor = type === 'safe' ? '#5cb85c' : '#d9534f';
            const marker = new google.maps.Marker({
                position, map,
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: iconColor, fillOpacity: 0.9, strokeColor: 'white', strokeWeight: 1.5 },
                sosType: type, sosDetails: details
            });

            marker.addListener('click', () => {
                if (infoWindow) { infoWindow.close(); }
                const pos = marker.getPosition();
                const content = `
                    <div class="info-window-content">
                        <h4>Alert Details</h4>
                        <p><b>Type:</b> ${marker.sosType.charAt(0).toUpperCase() + marker.sosType.slice(1)}</p>
                        <p><b>Risk:</b> ${marker.sosDetails.risk}</p>
                        <p><b>Distress:</b> ${marker.sosDetails.distress}</p>
                        <p><b>Location:</b> ${pos.lat().toFixed(5)}, ${pos.lng().toFixed(5)}</p>
                    </div>`;
                infoWindow = new google.maps.InfoWindow({ content });
                infoWindow.open(map, marker);
            });
            sosHistoryMarkers.push(marker);
            if (shouldSave) { saveSosHistoryToStorage(); }
        }
        
        function saveSosHistoryToStorage() {
            const pinsToSave = sosHistoryMarkers.map(marker => ({
                position: marker.getPosition().toJSON(), type: marker.sosType, details: marker.sosDetails
            }));
            localStorage.setItem('sosHistory', JSON.stringify(pinsToSave));
        }

        function clearSosPins() {
            if (confirm("Are you sure you want to clear all saved SOS pins?")) {
                sosHistoryMarkers.forEach(marker => marker.setMap(null));
                sosHistoryMarkers = [];
                localStorage.removeItem('sosHistory');
            }
        }
        
        // --- Core SOS and Geofence Functions ---

        function triggerMyLoctionSOS() {
            navigator.geolocation.getCurrentPosition((position) => {
                const userPos = { lat: position.coords.latitude, lng: position.coords.longitude };
                let isInsideGeofence = false;
                if (dangerZoneCenter && dangerZoneRadius) {
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(userPos), dangerZoneCenter);
                    if (distance <= dangerZoneRadius) { isInsideGeofence = true; }
                }
                const sosType = isInsideGeofence ? 'safe' : 'emergency';
                
                if (sosType === 'safe') {
                    const details = { risk: 'None', distress: 'Safe Check-in' };
                    // **MODIFIED ALERT**
                    alert(`âœ… Safe Check-in SENT! âœ…\n\nResponders notified you are safe at location:\n\nLatitude: ${userPos.lat.toFixed(5)}\nLongitude: ${userPos.lng.toFixed(5)}`);
                    addSosPinToMap(userPos, sosType, details);
                } else {
                    showSosModal(userPos, sosType);
                }
            }, () => { alert("Could not get your location for the SOS signal."); }, { enableHighAccuracy: true });
        }

        function sendPinnedSOS(lat, lng) {
            if (infoWindow) { infoWindow.close(); }
            if (pinnedMarker) { pinnedMarker.setMap(null); }
            showSosModal({ lat, lng }, 'pinned');
        }

        function placePinAndShowWindow(latLng) {
            if (infoWindow) { infoWindow.close(); }
            if (pinnedMarker) { pinnedMarker.setMap(null); }
            pinnedMarker = new google.maps.Marker({ position: latLng, map, title: 'Pinned Incident Location', icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: "#d9534f", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" } });
            const lat = latLng.lat(); const lng = latLng.lng();
            const contentString = `<div class="info-window-content"><h4>Incident Location</h4><p>Send an SOS alert for this pinned location?</p><button onclick="sendPinnedSOS(${lat},${lng})">Send SOS Alert</button></div>`;
            infoWindow = new google.maps.InfoWindow({ content: contentString });
            infoWindow.open(map, pinnedMarker);
        }

        // --- Unchanged Utility and Geofence Functions ---
        function loadGeofenceFromStorage() {
            const savedGeofence = localStorage.getItem('userGeofence');
            if (savedGeofence) {
                const geofenceData = JSON.parse(savedGeofence);
                dangerZoneCenter = geofenceData.center;
                dangerZoneRadius = geofenceData.radius;
                drawGeofenceCircle();
            }
        }
        function promptAndCreateGeofence(userPosition) {
            const radiusInput = prompt("Set your safety circle radius (in meters):", "500");
            if (radiusInput && !isNaN(radiusInput)) {
                dangerZoneCenter = { lat: userPosition.lat, lng: userPosition.lng };
                dangerZoneRadius = parseInt(radiusInput, 10);
                drawGeofenceCircle();
                saveGeofenceToStorage();
            } else if (radiusInput) { alert("Invalid input. Please enter a number."); }
        }
        function saveGeofenceToStorage() {
            if (dangerZoneCenter && dangerZoneRadius) {
                const geofenceData = { center: dangerZoneCenter, radius: dangerZoneRadius };
                localStorage.setItem('userGeofence', JSON.stringify(geofenceData));
            }
        }
        function resetGeofence() {
            if (!userMarker) { alert("Please wait until your location is found."); return; }
            localStorage.removeItem('userGeofence');
            if (dangerZoneCircle) { dangerZoneCircle.setMap(null); }
            dangerZoneCenter = null; dangerZoneRadius = null;
            alert("Safety circle reset.");
            promptAndCreateGeofence({lat: userMarker.getPosition().lat(), lng: userMarker.getPosition().lng()});
        }
        function drawGeofenceCircle() {
            if (dangerZoneCircle) { dangerZoneCircle.setMap(null); }
            dangerZoneCircle = new google.maps.Circle({
                strokeColor: '#FF0000', strokeOpacity: 0.8, strokeWeight: 2,
                fillColor: '#FF0000', fillOpacity: 0.35, map, center: dangerZoneCenter, radius: dangerZoneRadius
            });
        }
        function startLocationTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition((position) => {
                    const userPos = { lat: position.coords.latitude, lng: position.coords.longitude };
                    if (!userMarker) {
                        map.setCenter(userPos);
                        userMarker = new google.maps.Marker({
                            position: userPos, map, title: 'Your Location',
                            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#4285F4", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" }
                        });
                        if (!dangerZoneCenter) { promptAndCreateGeofence(userPos); }
                    } else { userMarker.setPosition(userPos); }
                    checkGeofence(userPos);
                }, () => { handleLocationError(true); });
            } else { handleLocationError(false); }
        }
        function checkGeofence(currentPosition) {
            if (!dangerZoneCenter || !dangerZoneRadius) return;
            const distance = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(currentPosition), dangerZoneCenter);
            if (distance <= dangerZoneRadius) {
                if (!hasEnteredDangerZone) {
                    hasEnteredDangerZone = true;
                    showStatusMessage('âš ï¸ You are inside your safety circle!', 'warning');
                }
            } else {
                if (hasEnteredDangerZone) {
                    hasEnteredDangerZone = false;
                    showStatusMessage('You have exited your safety circle.', 'safe');
                }
            }
        }
        function handleLocationError(browserHasGeolocation) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = browserHasGeolocation ? 'Error: Geolocation service failed. Please enable location access.' : "Error: Your browser doesn't support geolocation.";
        }
        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            if (type === 'warning') { statusDiv.style.backgroundColor = '#d9534f'; }
            else if (type === 'safe') { statusDiv.style.backgroundColor = '#5cb85c'; }
            else { statusDiv.style.backgroundColor = '#337ab7'; }
            setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
        }
    </script>

</body>
</html>